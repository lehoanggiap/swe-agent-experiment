name: SWE Agent Auto Issue Detection and Fix

on:
  schedule:
    # Run every day at 8 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - '**/*.py'
      - 'requirements.txt'

jobs:
  swe-agent-auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup SWE Agent
      run: |
        # Clone and install SWE Agent
        git clone https://github.com/princeton-nlp/SWE-agent.git swe-agent
        cd swe-agent
        pip install -e .

    - name: Run SWE Agent - Auto Detect and Fix Issues
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd swe-agent
        
        # Let SWE Agent scan the entire repository for issues
        python -m sweagent.agent.run \
          --model_name "gpt-4-turbo-2024-04-09" \
          --data_path "Scan this repository for any bugs, issues, or problems. If you find any issues, create a detailed GitHub issue describing the problem, then create a pull request with a fix. Focus on: 1) Test failures, 2) Code that could crash or cause errors, 3) Security vulnerabilities, 4) Code quality issues." \
          --repo_path "../" \
          --config_file "config/default_from_url.yaml" \
          --apply_patch_locally \
          --github_token "$GITHUB_TOKEN" \
        || echo "SWE Agent completed its analysis and fixes"

    - name: Summary
      run: |
        echo "ü§ñ SWE Agent has completed its autonomous analysis"
        echo "‚úÖ Scanned repository for issues"
        echo "üìù Created GitHub issues for any problems found"
        echo "üîß Applied fixes and created pull requests"
        echo "üëÄ Check the Issues and Pull Requests tabs for SWE Agent's work"